# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Build and Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [ created ]

jobs:
  build-native-linux-x86_64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential libomp-dev

      - name: Install Faiss
        run: |
          git clone --depth 1 --branch v1.7.4 https://github.com/facebookresearch/faiss.git
          cd faiss
          cmake -B build \
            -DFAISS_ENABLE_GPU=OFF \
            -DFAISS_ENABLE_PYTHON=OFF \
            -DBUILD_TESTING=OFF \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build -j $(nproc)
          sudo cmake --install build

      - name: Build native library
        run: |
          chmod +x scripts/build-native.sh
          ./scripts/build-native.sh --clean

      - name: Upload native library
        uses: actions/upload-artifact@v4
        with:
          name: native-linux-x86_64
          path: target/native/linux-x86_64/

  build-native-linux-aarch64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build in ARM64 container
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: ubuntu22.04
          install: |
            apt-get update
            apt-get install -y cmake build-essential libomp-dev git openjdk-8-jdk
            git clone --depth 1 --branch v1.7.4 https://github.com/facebookresearch/faiss.git
            cd faiss
            cmake -B build \
              -DFAISS_ENABLE_GPU=OFF \
              -DFAISS_ENABLE_PYTHON=OFF \
              -DBUILD_TESTING=OFF \
              -DCMAKE_BUILD_TYPE=Release
            cmake --build build -j $(nproc)
            cmake --install build
          run: |
            chmod +x scripts/build-native.sh
            ./scripts/build-native.sh --clean

      - name: Upload native library
        uses: actions/upload-artifact@v4
        with:
          name: native-linux-aarch64
          path: target/native/linux-aarch64/

  build-native-macos-x86_64:
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'

      - name: Install dependencies
        run: |
          brew install cmake libomp

      - name: Install Faiss
        run: |
          git clone --depth 1 --branch v1.7.4 https://github.com/facebookresearch/faiss.git
          cd faiss
          cmake -B build \
            -DFAISS_ENABLE_GPU=OFF \
            -DFAISS_ENABLE_PYTHON=OFF \
            -DBUILD_TESTING=OFF \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build -j $(sysctl -n hw.ncpu)
          sudo cmake --install build

      - name: Build native library
        run: |
          chmod +x scripts/build-native.sh
          ./scripts/build-native.sh --clean

      - name: Upload native library
        uses: actions/upload-artifact@v4
        with:
          name: native-osx-x86_64
          path: target/native/osx-x86_64/

  build-native-macos-aarch64:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'

      - name: Install dependencies
        run: |
          brew install cmake libomp

      - name: Install Faiss
        run: |
          git clone --depth 1 --branch v1.7.4 https://github.com/facebookresearch/faiss.git
          cd faiss
          cmake -B build \
            -DFAISS_ENABLE_GPU=OFF \
            -DFAISS_ENABLE_PYTHON=OFF \
            -DBUILD_TESTING=OFF \
            -DCMAKE_BUILD_TYPE=Release
          cmake --build build -j $(sysctl -n hw.ncpu)
          sudo cmake --install build

      - name: Build native library
        run: |
          chmod +x scripts/build-native.sh
          ./scripts/build-native.sh --clean

      - name: Upload native library
        uses: actions/upload-artifact@v4
        with:
          name: native-osx-aarch64
          path: target/native/osx-aarch64/

  package:
    needs:
      - build-native-linux-x86_64
      - build-native-linux-aarch64
      - build-native-macos-x86_64
      - build-native-macos-aarch64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'

      - name: Download Linux x86_64 native library
        uses: actions/download-artifact@v4
        with:
          name: native-linux-x86_64
          path: target/native/linux-x86_64/

      - name: Download Linux aarch64 native library
        uses: actions/download-artifact@v4
        with:
          name: native-linux-aarch64
          path: target/native/linux-aarch64/

      - name: Download macOS x86_64 native library
        uses: actions/download-artifact@v4
        with:
          name: native-osx-x86_64
          path: target/native/osx-x86_64/

      - name: Download macOS aarch64 native library
        uses: actions/download-artifact@v4
        with:
          name: native-osx-aarch64
          path: target/native/osx-aarch64/

      - name: List native libraries
        run: |
          echo "Native libraries:"
          find target/native -type f | head -20

      - name: Build JAR
        run: mvn package -DskipTests

      - name: Upload JAR
        uses: actions/upload-artifact@v4
        with:
          name: paimon-faiss-jni-jar
          path: target/*.jar

  test:
    needs: package
    strategy:
      matrix:
        os: [ubuntu-latest, macos-14]
        java: ['8', '11', '17']
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'

      - name: Download JAR
        uses: actions/download-artifact@v4
        with:
          name: paimon-faiss-jni-jar
          path: target/

      - name: Run tests
        run: mvn test

  publish:
    needs: test
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'
          server-id: ossrh
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg-passphrase: GPG_PASSPHRASE

      - name: Download all native libraries
        uses: actions/download-artifact@v4
        with:
          path: target/native/
          pattern: native-*
          merge-multiple: true

      - name: Publish to Maven Central
        run: mvn deploy -P release -DskipTests
        env:
          MAVEN_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.OSSRH_TOKEN }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

