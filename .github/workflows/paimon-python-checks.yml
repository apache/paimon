################################################################################
#  Licensed to the Apache Software Foundation (ASF) under one
#  or more contributor license agreements.  See the NOTICE file
#  distributed with this work for additional information
#  regarding copyright ownership.  The ASF licenses this file
#  to you under the Apache License, Version 2.0 (the
#  "License"); you may not use this file except in compliance
#  with the License.  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
# limitations under the License.
################################################################################

name: Check Code Style and Test

on:
  push:
  pull_request:
    paths:
      - 'paimon-python/**'
      - '!**/*.md'
      - '.github/workflows/paimon-python-checks.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.event.number || github.run_id }}
  cancel-in-progress: true

jobs:
  lint-python:
    runs-on: ubuntu-latest
    # Use official python:3.6.15 container; no need to install via setup-python inside
    container: python:3.6.15

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Show Python version
        run: |
          python --version
          which python
          pip --version || true

      - name: Pin legacy build tooling for py3.6
        env:
          PIP_NO_CACHE_DIR: 1
        run: |
          # Last pip that supports Python 3.6 is 21.2.4.
          # setuptools 59.6.0 and wheel 0.38.4 still work with 3.6.
          /usr/local/bin/python -m pip install --upgrade \
            "pip==21.3.1" \
            "setuptools==59.6.0" \
            "wheel==0.37.1"
          pip --version
          python -m pip debug --verbose

      - name: Install system build deps (container runs as root; no sudo required)
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            build-essential \
            pkg-config \
            curl \
            ca-certificates
          rm -rf /var/lib/apt/lists/*
          
      - name: Install Python dependencies (pin to py3.6-compatible versions)
        env:
          PIP_NO_CACHE_DIR: 1
          PIP_DISABLE_PIP_VERSION_CHECK: 1
          PIP_ROOT_USER_ACTION: ignore
        run: |
          # Core libs (last Py3.6-compatible)
          python -m pip install "numpy==1.19.5" --only-binary=:all:
          python -m pip install "pandas==1.1.5" --only-binary=:all:

          # Try pyarrow 6.0.1 then 6.0.0; only warn if both fail
          if ! python -m pip install "pyarrow==6.0.1" --only-binary=:all: ; then
            if ! python -m pip install "pyarrow==6.0.0" --only-binary=:all: ; then
              echo "PyArrow wheel not available for this platform."
            fi
          fi

          # Other libs pinned to Py3.6
          python -m pip install \
            "readerwriterlock==1.0.9" \
            "fsspec==2021.10.1" \
            "cachetools==4.2.4" \
            "ossfs==2021.8.0" \
            "fastavro==1.4.7" \
            "zstandard==0.15.2" \
            "flake8==4.0.1" \
            "pytest==6.2.5" \
            "polars==0.9.12" \
            "duckdb==0.8.1" \
            "py4j==0.10.9.9" \
            "requests<3"

      - name: Run lint-python.sh
        run: |
          chmod +x paimon-python/dev/lint-python.sh
          ./paimon-python/dev/lint-python.sh
